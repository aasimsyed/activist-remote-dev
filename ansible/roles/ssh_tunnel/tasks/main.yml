---
- name: Install autossh
  ansible.builtin.apt:
    name: autossh
    state: present

- name: Create systemd service directory
  ansible.builtin.file:
    path: /etc/systemd/system
    state: directory
    mode: '0755'

- name: Create tunnel user
  ansible.builtin.user:
    name: tunneluser
    create_home: false
    system: true

- name: Deploy SSH tunnel service
  ansible.builtin.template:
    src: ssh-tunnel.service.j2
    dest: /etc/systemd/system/ssh-tunnel.service
    mode: '0644'
  notify: reload systemd

- name: Start and enable tunnel service
  ansible.builtin.systemd:
    name: ssh-tunnel
    enabled: true
    state: started

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
